<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>GKE on Kishan&#39;s World</title>
    <link>http://kishansharma.in/tags/gke/</link>
    <description>Recent content in GKE on Kishan&#39;s World</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language><atom:link href="http://kishansharma.in/tags/gke/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Extend CIDR</title>
      <link>http://kishansharma.in/posts/extend-cidr/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>http://kishansharma.in/posts/extend-cidr/</guid>
      <description>Guide to extend CIDR Range in the existing GKE cluster</description>
      <content:encoded><![CDATA[<p>A <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/alias-ips">VPC native cluster</a> uses three unique subnet ranges to allocate IPs to Nodes, Pods and Services.</p>
<p>Primary subnet IP address is used for Nodes. Node IP provides connectivity from control components like kube-proxy and kubelet to the Kubernetes API server. Node IP is the node’s connection to the rest of the cluster.</p>
<p>Secondary subnet IP address is used for Pods. Pod IP addresses are natively routable within the cluster’s VPC network and other VPC networks connected to it by VPC Network Peering. By default GKE allocates /24 alias ie., 256 alias IP addresses for 110 pods for each of the nodes.</p>
<p>Another Secondary subnet IP address is used for services. Each Service has an IP address, called the ClusterIP, assigned from the cluster’s VPC network.</p>
<p>In a VPC native cluster, these addresses are reserved before the creation of cluster to eliminate conflict and overlapping of IPs.</p>
<p>What happens when the secondary IP range exhausts?</p>
<p>Once the secondary IP address exhausts no Pods can be scheduled. The secondary Pod IP range cannot be changed once created. There is a provision to allocate a separate IP range to create separate node pools in the cluster. These two IP ranges are going to be discontigous and there are some caveats which needs to be taken care of.</p>
<p>If you use ip-masq-agent configured with the nonMasqueradeCIDRs parameter, you must update the nonMasqueradeCIDRs to include all Pod CIDR ranges.</p>
<p>If you use NetworkPolicy configured with ipBlock to specify traffic, you must update the cidr value to include all Pod CIDR ranges.</p>
<p>The other approach is to create a bigger CIDR range node pool and move workloads from the existing node pool to the newly created one. Steps for the same:</p>
<ol>
<li>
<p>Mark the nodes in the existing node pool to be non schedulable by using the kubernetes cordon command</p>
<p><code>kubectl cordon &lt;node-name&gt;</code></p>
</li>
<li>
<p>Redeploy the application and verify if the nodes are scheduling in the nodes of new node pool</p>
</li>
<li>
<p>Once verified, redeploy and move all the workloads in the new node pool.</p>
</li>
<li>
<p>Clean up and delete the old node pool.</p>
</li>
</ol>
]]></content:encoded>
    </item>
    
    <item>
      <title>Intro to Gateway API</title>
      <link>http://kishansharma.in/posts/intro-to-gateway-api/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>http://kishansharma.in/posts/intro-to-gateway-api/</guid>
      <description>Gateway API in Kubernetes</description>
      <content:encoded><![CDATA[<h2 id="ingress-vs-gateway-api">Ingress vs Gateway API</h2>
<h3 id="ingress-supports-the-following">Ingress supports the following</h3>
<ul>
<li>HTTP host matching</li>
<li>HTTP path matching</li>
<li>TLS termination</li>
<li>Routing to service:port</li>
<li>For many different load balancer implementations</li>
</ul>
<h3 id="gateway-adds">Gateway adds</h3>
<ul>
<li>HTTP header-based matching</li>
<li>HTTP header manipulation</li>
<li>Weighted traffic splitting</li>
<li>Traffic mirroring</li>
<li>Role-oriented resource model</li>
</ul>
<h3 id="and-has-extensibility-for">and has extensibility for</h3>
<ul>
<li>Arbitrary backend CRD references (buckets, functions, etc)</li>
<li>Routing for other protocols(gRPC)</li>
<li>Custom parameters or configuration (LB algos, custom match types, etc)</li>
</ul>
<p>Gateway controller manage the network infrastructure on behalf of Gateway resources. There are one or more Gateway classes supported by a Gateway controller. Gateways are created from the Gateway classes and they model the actual network infrastructure which processes the traffic. Gateways can model many different kinds of data planes that perform routing.</p>
<p>Then comes the route resources. Gateway and the HTTP route resources do what the ingress resource does as a single resource. This separation allows different roles to deploy and own that resource. It allows a cluster administrator to mange the Gateway and the policies attached to that Gateway, while individual development teams manage the routing to their application on their own.</p>
<p><img loading="lazy" src="/img/gateway_02.png" alt="roles"  />
</p>
<h2 id="roles-involved">Roles involved</h2>
<h3 id="infrastructure-provider">Infrastructure Provider</h3>
<p>ensures that each cluster is provisioned with a <code>GatewayClass</code> ****for external load balancers</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">GatewayClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">external-lb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">mygroup.io/gateway</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parametersRef</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">group</span>: <span style="color:#ae81ff">k8s.mygroup.io</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">GatewayClassParams</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">external-lb</span>
</span></span></code></pre></div><h3 id="cluster-operator">Cluster Operator</h3>
<p>Creates a <code>Gateway</code> for the mygroup team when setting up the cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Gateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mygroup-external</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gatewayClassName</span>: <span style="color:#ae81ff">external-lb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listeners</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HTTPRoute</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">matchLebels</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">gateway</span>: <span style="color:#ae81ff">mygroup-external</span>
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></div><h3 id="application-developer">Application Developer</h3>
<p>creates an HTTPRoute to route external traffic to the application</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HTTPRoute</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mygroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">gateway</span>: <span style="color:#ae81ff">mygroup-external</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostnames</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">mygroup.io</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">matches</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/groups</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">forwardTo</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">mygroup-groups</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><h2 id="features">Features</h2>
<h3 id="canary-rollout">Canary Rollout</h3>
<p>Application developer wants to do a canary rollout</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HTTPRoute</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">matches</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/groups</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">forwardTo</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">mygroup-groups</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">mygroup-groups-canary</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><h3 id="upgrade-load-balancer">Upgrade Load Balancer</h3>
<p>Cluster operator wants to upgrade to the newest kind of LB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Gateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mygroup-external</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gatewayClassName</span>: <span style="color:#ae81ff">new-external-lb</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listeners</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HTTPRoute</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">matchLebels</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">gateway</span>: <span style="color:#ae81ff">mygroup-external</span>
</span></span></code></pre></div><h3 id="update-infrastructure-provider">Update Infrastructure Provider</h3>
<p>Infrastructure provider wants to provision on a new provider</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">GatewayClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">external-lb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">new-vendor.io/gateway</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parametersRef</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">group</span>: <span style="color:#ae81ff">k8s.mygroup.io</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">GatewayClassParams</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">external-lb</span>
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
  </channel>
</rss>
